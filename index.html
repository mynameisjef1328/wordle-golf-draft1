<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pardle Online</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <style>
    :root {
      --bg: #f5f5f5;
      --bg-card: #ffffff;
      --text: #111111;
      --accent: #ff9800;
      --accent-soft: #ffe0b2;
      --border-soft: #dddddd;
      --header-bg: #ffffff;
      --sync-bg: #00c853;
      --sync-text: #ffffff;
      --table-header-bg: #e0e0e0;
      --table-header-text: #111111;
      --table-player-header-bg: #000000;
      --table-player-header-text: #ffffff;
      --input-bg: #ffffff;
      --input-text: #000000;
    }

    body.dark {
      --bg: #101010;
      --bg-card: #181818;
      --text: #f5f5f5;
      --accent: #ff9800;
      --accent-soft: #664200;
      --border-soft: #333333;
      --header-bg: #181818;
      --sync-bg: #00c853;
      --sync-text: #ffffff;
      --table-header-bg: #333333;
      --table-header-text: #ffffff;
      --table-player-header-bg: #000000;
      --table-player-header-text: #ffffff;
      --input-bg: #202020;
      --input-text: #ffffff;
    }

    * {
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text);
    }

    .app-shell {
      max-width: 480px;
      margin: 0 auto;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .app-header {
      background: var(--header-bg);
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-soft);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .app-title {
      font-size: 20px;
      font-weight: 700;
    }

    .sync-pill {
      padding: 4px 10px;
      border-radius: 999px;
      background: var(--sync-bg);
      color: var(--sync-text);
      font-size: 12px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .sync-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #ffffff;
    }

    .app-content {
      padding: 12px 12px 24px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      flex: 1;
    }

    .card {
      background: var(--bg-card);
      border-radius: 14px;
      padding: 12px;
      border: 1px solid var(--border-soft);
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }

    .section-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    /* online controls */

    .online-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
      font-size: 13px;
    }

    .online-row {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .online-row label {
      min-width: 80px;
    }

    .online-input {
      flex: 1;
      min-width: 0;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      background: var(--input-bg);
      color: var(--input-text);
      font-size: 14px;
    }

    .online-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .small-btn {
      padding: 8px 10px;
      border-radius: 999px;
      border: none;
      background: var(--accent);
      color: #ffffff;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      flex: 1;
      min-width: 0;
      text-align: center;
    }

    .small-btn.secondary {
      background: var(--accent-soft);
      color: #000000;
    }

    .online-status {
      font-size: 12px;
      line-height: 1.4;
      color: #555;
    }

    .online-status strong {
      color: var(--text);
    }

    .error-text {
      color: #d32f2f;
    }

    /* course selector */

    .course-row {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .course-select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      font-size: 14px;
      background: var(--input-bg);
      color: var(--input-text);
    }

    /* theme toggle and rules */

    .toolbar-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      font-size: 14px;
    }

    .theme-toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .theme-toggle span.label {
      font-size: 13px;
    }

    .theme-toggle input {
      opacity: 0;
      width: 0;
      height: 0;
      position: absolute;
    }

    .theme-toggle .slider {
      width: 40px;
      height: 20px;
      border-radius: 999px;
      background: #cccccc;
      position: relative;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .theme-toggle .slider::before {
      content: "";
      position: absolute;
      width: 16px;
      height: 16px;
      left: 2px;
      top: 2px;
      border-radius: 50%;
      background: #ffffff;
      transition: transform 0.2s ease;
    }

    .theme-toggle input:checked + .slider {
      background: #000000;
    }

    .theme-toggle input:checked + .slider::before {
      transform: translateX(20px);
    }

    .rules-link {
      font-size: 13px;
      text-align: right;
    }

    .rules-link button {
      border: none;
      background: none;
      color: var(--accent);
      text-decoration: none;
      font-weight: 600;
      font-size: 13px;
      padding: 0;
      cursor: pointer;
    }

    .rules-link button:active {
      opacity: 0.7;
    }

    /* scorecard */

    .scorecard-wrapper {
      overflow-x: auto;
      padding-bottom: 4px;
      position: relative;
    }

    .scorecard-table {
      border-collapse: collapse;
      min-width: 1000px;
      width: 100%;
      font-size: 13px;
    }

    .scorecard-table th,
    .scorecard-table td {
      border: 1px solid var(--border-soft);
      text-align: center;
      padding: 6px 4px;
      white-space: nowrap;
    }

    .scorecard-table th.course-label {
      background: var(--table-header-bg);
      color: var(--table-header-text);
      text-align: left;
      padding-left: 8px;
      position: sticky;
      left: 0;
      z-index: 3;
    }

    .scorecard-table th.player-label {
      background: var(--table-player-header-bg);
      color: var(--table-player-header-text);
      text-align: left;
      padding-left: 8px;
      position: sticky;
      left: 0;
      z-index: 3;
    }

    .scorecard-table th.hole-header {
      background: var(--table-header-bg);
      color: var(--table-header-text);
      font-weight: 600;
    }

    .par-cell {
      background: #bdbdbd;
      font-weight: 600;
    }

    .score-input {
      width: 34px;
      height: 30px;
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      background: var(--input-bg);
      color: var(--input-text);
      text-align: center;
      font-size: 14px;
    }

    .score-input:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .player-name {
      width: 100%;
      border: none;
      background: transparent;
      color: var(--table-player-header-text);
      text-align: left;
      padding: 0;
      font-weight: 500;
    }

    .player-name:disabled {
      opacity: 0.7;
    }

    .total-col {
      background: #212121;
      color: #ffffff;
      font-weight: 600;
      min-width: 52px;
    }

    .swipe-hint {
      margin-top: 6px;
      font-size: 11px;
      text-align: right;
      opacity: 0.7;
    }

    .rules-card {
      display: none;
    }

    .rules-card.visible {
      display: block;
    }

    .rules-text {
      font-size: 13px;
      line-height: 1.45;
      white-space: pre-line;
    }

    @media (min-width: 520px) {
      .app-content {
        padding-inline: 16px;
      }
    }
  </style>
</head>
<body class="light">
  <div class="app-shell">
    <header class="app-header">
      <div class="app-title">Pardle Online</div>
      <div class="sync-pill">
        <span class="sync-dot"></span>
        Online
      </div>
    </header>

    <main class="app-content">

      <!-- Online game controls -->
      <section class="card">
        <div class="section-title">Online Game</div>
        <div class="online-grid">
          <div class="online-row">
            <label for="playerNameInput">Your name</label>
            <input id="playerNameInput" class="online-input" placeholder="Jeff, Niece, etc." />
          </div>

          <div class="online-row online-buttons">
            <button id="createGameBtn" class="small-btn">Create Game</button>
            <input id="joinGameIdInput" class="online-input" placeholder="Enter game code" />
            <button id="joinGameBtn" class="small-btn secondary">Join Game</button>
          </div>

          <div class="online-status" id="onlineStatusText">
            Game ID: <strong id="gameIdDisplay">none</strong><br />
            Not in a game. Create or join to start.
          </div>
        </div>
      </section>

      <!-- Course selector -->
      <section class="card">
        <div class="section-title">Course</div>
        <div class="course-row">
          <select class="course-select" id="courseSelect" disabled>
            <option value="st-andrews">St. Androos Links</option>
            <option value="augusta">Azalea National</option>
            <option value="bully-pulpit">Badlands Pulpit</option>
            <option value="torrey-pines">Torrey Pints</option>
            <option value="bethpage-black">Bethpage Back Tees</option>
            <option value="sweetwater">Sweetwater Country Klub</option>
            <option value="tpc-sawgrass">TPC Strawgrass</option>
            <option value="whistling-straits">Whistling Straights</option>
            <option value="pebble-beach">Pebble Reach</option>
            <option value="congressional">Congress-ish National</option>
          </select>
        </div>
      </section>

      <!-- Toolbar -->
      <section class="card">
        <div class="toolbar-row">
          <label class="theme-toggle">
            <span class="label">Theme</span>
            <input type="checkbox" id="themeSwitch" />
            <span class="slider"></span>
          </label>

          <div class="rules-link">
            <button id="rulesLink" type="button">View Pardle Rules</button>
          </div>
        </div>
      </section>

      <!-- Scorecard -->
      <section class="card">
        <div class="section-title">Scorecard</div>
        <div class="scorecard-wrapper">
          <table class="scorecard-table">
            <thead>
              <tr>
                <th class="course-label">Course</th>
                <th class="hole-header">1</th>
                <th class="hole-header">2</th>
                <th class="hole-header">3</th>
                <th class="hole-header">4</th>
                <th class="hole-header">5</th>
                <th class="hole-header">6</th>
                <th class="hole-header">7</th>
                <th class="hole-header">8</th>
                <th class="hole-header">9</th>
                <th class="hole-header">10</th>
                <th class="hole-header">11</th>
                <th class="hole-header">12</th>
                <th class="hole-header">13</th>
                <th class="hole-header">14</th>
                <th class="hole-header">15</th>
                <th class="hole-header">16</th>
                <th class="hole-header">17</th>
                <th class="hole-header">18</th>
                <th class="hole-header">Total</th>
              </tr>
            </thead>
            <tbody>
              <tr id="parRow">
                <th class="course-label">Par</th>
                <td class="par-cell" data-hole="0"></td>
                <td class="par-cell" data-hole="1"></td>
                <td class="par-cell" data-hole="2"></td>
                <td class="par-cell" data-hole="3"></td>
                <td class="par-cell" data-hole="4"></td>
                <td class="par-cell" data-hole="5"></td>
                <td class="par-cell" data-hole="6"></td>
                <td class="par-cell" data-hole="7"></td>
                <td class="par-cell" data-hole="8"></td>
                <td class="par-cell" data-hole="9"></td>
                <td class="par-cell" data-hole="10"></td>
                <td class="par-cell" data-hole="11"></td>
                <td class="par-cell" data-hole="12"></td>
                <td class="par-cell" data-hole="13"></td>
                <td class="par-cell" data-hole="14"></td>
                <td class="par-cell" data-hole="15"></td>
                <td class="par-cell" data-hole="16"></td>
                <td class="par-cell" data-hole="17"></td>
                <td class="par-cell par-total">-</td>
              </tr>

              <!-- Player rows map directly to players[0..3] -->

              <tr class="player-row" data-slot="0">
                <th class="player-label">
                  <input class="player-name" placeholder="Player 1" disabled />
                </th>
                <!-- 18 holes -->
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td class="total-col">E</td>
              </tr>

              <tr class="player-row" data-slot="1">
                <th class="player-label">
                  <input class="player-name" placeholder="Player 2" disabled />
                </th>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td class="total-col">E</td>
              </tr>

              <tr class="player-row" data-slot="2">
                <th class="player-label">
                  <input class="player-name" placeholder="Player 3" disabled />
                </th>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td class="total-col">E</td>
              </tr>

              <tr class="player-row" data-slot="3">
                <th class="player-label">
                  <input class="player-name" placeholder="Player 4" disabled />
                </th>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td><input class="score-input" type="number" min="1" disabled /></td>
                <td class="total-col">E</td>
              </tr>
            </tbody>
          </table>
        </div>
        <p class="swipe-hint">Swipe sideways to see holes 10–18 ⟶</p>
      </section>

      <!-- Rules -->
      <section class="card rules-card" id="rulesCard">
        <div class="section-title">Pardle Rules</div>
        <div class="rules-text">
Pardle is Wordle meets golf.

- Each "hole" represents one Wordle puzzle.
- Your score for a hole is the number of guesses it took to solve that Wordle.
- If you did not solve it, you can score it as 7 or "X" by agreement with your group.
- Par is the target number of guesses for each hole.

Scoring:
- Total score is the sum of your guesses over the round.
- Relative score is total versus par, just like golf.
  - Lower is better.
  - "E" means even with par.
  - "+2" means two over par.
  - "-1" means one under par.

Use Pardle to track your group scores, talk trash, and keep it friendly.
        </div>
      </section>
    </main>
  </div>

  <script>
    // 1. Firebase setup with your config
    const firebaseConfig = {
      apiKey: "AIzaSyDxmmTSpvM1xvVRb8qiOQfbbQWHSJEgIrk",
      authDomain: "pardle-online.firebaseapp.com",
      projectId: "pardle-online",
      storageBucket: "pardle-online.firebasestorage.app",
      messagingSenderId: "552026596516",
      appId: "1:552026596516:web:779d08f94ef455eda7f231",
      measurementId: "G-SJLZZ84L8F"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // 2. Constants and state
    const STORAGE_PLAYER_ID_KEY = "pardle_online_player_id";
    const STORAGE_LAST_GAME_ID_KEY = "pardle_online_last_game_id";
    const STORAGE_LAST_SLOT_KEY = "pardle_online_last_player_slot";

    const COURSES = {
      "st-andrews": [4,4,4,4,5,4,4,3,4,4,3,4,4,5,4,4,4,4],
      "augusta": [4,5,4,3,4,3,4,5,4,4,4,3,5,4,5,3,4,4],
      "bully-pulpit": [4,4,4,5,5,3,4,3,4,4,5,3,4,4,3,4,5,4],
      "torrey-pines": [4,4,3,4,5,4,4,3,5,5,4,3,4,4,3,4,5,4],
      "bethpage-black": [4,4,3,5,4,4,5,3,4,4,4,4,5,3,4,4,3,4],
      "sweetwater": [4,4,3,4,5,3,4,4,3,4,4,3,4,5,3,4,4,3],
      "tpc-sawgrass": [4,5,3,4,4,4,4,3,5,4,5,4,3,4,4,5,3,4],
      "whistling-straits": [4,5,3,4,5,4,3,4,4,4,5,3,4,4,4,5,3,4],
      "pebble-beach": [4,5,4,4,3,5,3,4,4,4,4,3,4,5,4,4,3,5],
      "congressional": [4,3,4,5,4,5,3,4,5,3,5,4,3,4,5,5,4,4]
    };

    const MAX_PLAYERS = 4;
    const HOLES = 18;

    let currentGameId = null;
    let currentPlayerId = null;
    let currentPlayerSlot = null;
    let currentGameData = null;
    let unsubscribeGame = null;

    // DOM references
    const body = document.body;
    const themeSwitch = document.getElementById("themeSwitch");
    const rulesLink = document.getElementById("rulesLink");
    const rulesCard = document.getElementById("rulesCard");

    const playerNameInput = document.getElementById("playerNameInput");
    const createGameBtn = document.getElementById("createGameBtn");
    const joinGameBtn = document.getElementById("joinGameBtn");
    const joinGameIdInput = document.getElementById("joinGameIdInput");
    const onlineStatusText = document.getElementById("onlineStatusText");

    const courseSelect = document.getElementById("courseSelect");
    const parCells = document.querySelectorAll(".par-cell[data-hole]");
    const parTotalCell = document.querySelector(".par-total");
    const playerRows = document.querySelectorAll(".player-row");

    // helpers
    function generateId(len = 20) {
      const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
      let out = "";
      for (let i = 0; i < len; i++) {
        out += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return out;
    }

    function getOrCreatePlayerId() {
      let id = localStorage.getItem(STORAGE_PLAYER_ID_KEY);
      if (!id) {
        id = generateId(16);
        localStorage.setItem(STORAGE_PLAYER_ID_KEY, id);
      }
      return id;
    }

    function setStatus(msg, isError = false) {
      const gameIdText = currentGameId || "none";
      onlineStatusText.innerHTML = `Game ID: <strong>${gameIdText}</strong><br />${msg}`;
      if (isError) {
        onlineStatusText.classList.add("error-text");
      } else {
        onlineStatusText.classList.remove("error-text");
      }
    }

    function enableScorecard(enabled) {
      courseSelect.disabled = !enabled;
      playerRows.forEach(row => {
        const slot = parseInt(row.dataset.slot, 10);
        const isMine = enabled && currentPlayerSlot === slot;
        const nameInput = row.querySelector(".player-name");
        const scoreInputs = row.querySelectorAll(".score-input");
        nameInput.disabled = !isMine;
        scoreInputs.forEach(inp => inp.disabled = !isMine);
      });
    }

    function updateParRow() {
      const courseId = currentGameData ? currentGameData.courseId : courseSelect.value;
      const pars = COURSES[courseId];
      if (!pars) return;

      let parTotal = 0;

      parCells.forEach(cell => {
        const idx = parseInt(cell.dataset.hole, 10);
        const value = pars[idx];
        if (typeof value === "number") {
          cell.textContent = value;
          parTotal += value;
        } else {
          cell.textContent = "";
        }
      });

      parTotalCell.textContent = parTotal > 0 ? parTotal : "-";
      recalcAllTotals();
    }

    function recalcAllTotals() {
      const courseId = currentGameData ? currentGameData.courseId : courseSelect.value;
      const pars = COURSES[courseId] || [];

      const rows = document.querySelectorAll("tbody tr");
      rows.forEach(row => {
        if (row.id === "parRow") return;

        const scoreInputs = row.querySelectorAll(".score-input");
        if (!scoreInputs.length) return;

        let scoreTotal = 0;
        let parTotalPlayed = 0;

        scoreInputs.forEach((input, idx) => {
          const val = parseInt(input.value, 10);
          if (!isNaN(val) && val > 0) {
            scoreTotal += val;
            const parVal = pars[idx];
            if (typeof parVal === "number") {
              parTotalPlayed += parVal;
            }
          }
        });

        const totalCell = row.querySelector(".total-col");
        if (!totalCell) return;

        if (scoreTotal === 0) {
          totalCell.textContent = "E";
          return;
        }

        if (parTotalPlayed === 0) {
          totalCell.textContent = scoreTotal;
          return;
        }

        const diff = scoreTotal - parTotalPlayed;
        if (diff === 0) {
          totalCell.textContent = "E";
        } else if (diff > 0) {
          totalCell.textContent = "+" + diff;
        } else {
          totalCell.textContent = diff.toString();
        }
      });
    }

    function readScoresFromSlot(slot) {
      const row = document.querySelector(`.player-row[data-slot="${slot}"]`);
      if (!row) return Array(HOLES).fill(null);

      const inputs = row.querySelectorAll(".score-input");
      const scores = [];
      inputs.forEach(inp => {
        const v = inp.value;
        scores.push(v === "" ? null : Number(v));
      });
      return scores;
    }

    function applyGameToUI(data) {
      if (!data) return;

      currentGameData = data;

      const courseId = data.courseId || "st-andrews";
      if (COURSES[courseId]) {
        courseSelect.value = courseId;
      }
      updateParRow();

      const players = Array.isArray(data.players) ? data.players : [];

      for (let i = 0; i < MAX_PLAYERS; i++) {
        const row = document.querySelector(`.player-row[data-slot="${i}"]`);
        if (!row) continue;
        const nameInput = row.querySelector(".player-name");
        const scoreInputs = row.querySelectorAll(".score-input");

        const p = players[i];
        if (p && p.id) {
          nameInput.value = p.name || "";
          const scores = Array.isArray(p.scores) ? p.scores : [];
          for (let h = 0; h < HOLES; h++) {
            const score = scores[h];
            scoreInputs[h].value = score == null ? "" : score;
          }
        } else {
          nameInput.value = "";
          scoreInputs.forEach(inp => inp.value = "");
        }
      }

      // mirror your own name into the "Your name" box if we know your slot
      if (currentPlayerSlot != null && players[currentPlayerSlot]) {
        playerNameInput.value = players[currentPlayerSlot].name || "";
      }

      recalcAllTotals();
    }

    function bindScoreInputs() {
      playerRows.forEach(row => {
        const slot = parseInt(row.dataset.slot, 10);
        const nameInput = row.querySelector(".player-name");
        const scoreInputs = row.querySelectorAll(".score-input");

        nameInput.addEventListener("input", () => {
          if (currentGameId && currentPlayerSlot === slot) {
            updatePlayerInGame();
          }
        });

        scoreInputs.forEach(inp => {
          inp.addEventListener("input", () => {
            if (currentGameId && currentPlayerSlot === slot) {
              updatePlayerInGame();
            }
          });
        });
      });

      courseSelect.addEventListener("change", () => {
        if (!currentGameId || !currentGameData) {
          updateParRow();
          return;
        }
        const newCourseId = courseSelect.value;
        const updated = { ...currentGameData, courseId: newCourseId };
        currentGameData = updated;
        db.collection("games").doc(currentGameId).set(updated);
      });
    }

    async function updatePlayerInGame() {
      if (!currentGameId || currentPlayerSlot == null || !currentGameData) return;

      const row = document.querySelector(`.player-row[data-slot="${currentPlayerSlot}"]`);
      if (!row) return;

      const nameInput = row.querySelector(".player-name");
      const scores = readScoresFromSlot(currentPlayerSlot);

      const updated = { ...currentGameData };
      const players = Array.isArray(updated.players) ? [...updated.players] : [];

      while (players.length < MAX_PLAYERS) {
        players.push({ id: null, name: "", scores: Array(HOLES).fill(null) });
      }

      players[currentPlayerSlot] = {
        id: currentPlayerId,
        name: nameInput.value || "",
        scores
      };

      updated.players = players;
      currentGameData = updated;

      await db.collection("games").doc(currentGameId).set(updated);
      recalcAllTotals();
    }

    async function createGame() {
      const name = playerNameInput.value.trim();
      if (!name) {
        setStatus("Enter your name before creating a game.", true);
        return;
      }

      currentPlayerId = getOrCreatePlayerId();
      currentPlayerSlot = 0;

      const emptyScores = Array(HOLES).fill(null);
      const players = [];
      for (let i = 0; i < MAX_PLAYERS; i++) {
        players.push({ id: null, name: "", scores: emptyScores });
      }
      players[0] = { id: currentPlayerId, name, scores: emptyScores };

      const initialCourseId = courseSelect.value || "st-andrews";

      const docRef = await db.collection("games").add({
        courseId: initialCourseId,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        players
      });

      currentGameId = docRef.id;

      // remember last game + slot on this device
      localStorage.setItem(STORAGE_LAST_GAME_ID_KEY, currentGameId);
      localStorage.setItem(STORAGE_LAST_SLOT_KEY, String(currentPlayerSlot));

      setStatus("Game created. Share this code with your friends.");

      if (unsubscribeGame) unsubscribeGame();
      unsubscribeGame = docRef.onSnapshot(snap => {
        if (!snap.exists) {
          setStatus("Game was deleted or not found.", true);
          enableScorecard(false);
          return;
        }
        applyGameToUI(snap.data());
        enableScorecard(true);
      });
    }

    // joinGame preserves scores for returning players and remembers last game
    async function joinGame() {
      const name = playerNameInput.value.trim();
      if (!name) {
        setStatus("Enter your name before joining a game.", true);
        return;
      }

      const joinId = joinGameIdInput.value.trim();
      if (!joinId) {
        setStatus("Enter a game code to join.", true);
        return;
      }

      currentPlayerId = getOrCreatePlayerId();

      const docRef = db.collection("games").doc(joinId);
      const snap = await docRef.get();
      if (!snap.exists) {
        setStatus("Game not found. Check the code and try again.", true);
        return;
      }

      const data = snap.data() || {};
      let players = Array.isArray(data.players) ? [...data.players] : [];
      while (players.length < MAX_PLAYERS) {
        players.push({ id: null, name: "", scores: Array(HOLES).fill(null) });
      }

      // Look for this player by their stored ID
      let slot = players.findIndex(p => p && p.id === currentPlayerId);

      if (slot === -1) {
        // New player in this game – grab first empty slot, start with empty scores
        slot = players.findIndex(p => !p || !p.id);
        if (slot === -1) {
          setStatus("This game already has 4 players.", true);
          return;
        }

        const emptyScores = Array(HOLES).fill(null);
        players[slot] = {
          id: currentPlayerId,
          name,
          scores: emptyScores
        };
      } else {
        // Existing player – keep their old scores, just update name if changed
        const existing = players[slot] || {};
        players[slot] = {
          id: existing.id || currentPlayerId,
          name: name || existing.name || "",
          scores: Array.isArray(existing.scores)
            ? existing.scores
            : Array(HOLES).fill(null)
        };
      }

      await docRef.set({
        ...data,
        players
      });

      currentGameId = joinId;
      currentPlayerSlot = slot;

      // remember last game + slot on this device
      localStorage.setItem(STORAGE_LAST_GAME_ID_KEY, currentGameId);
      localStorage.setItem(STORAGE_LAST_SLOT_KEY, String(currentPlayerSlot));

      setStatus(`Joined game in slot ${slot + 1}.`);

      if (unsubscribeGame) unsubscribeGame();
      unsubscribeGame = docRef.onSnapshot(s => {
        if (!s.exists) {
          setStatus("Game was deleted or not found.", true);
          enableScorecard(false);
          return;
        }
        applyGameToUI(s.data());
        enableScorecard(true);
      });
    }

    // Auto-rejoin last game on load if possible
    async function attemptAutoRejoin() {
      const savedGameId = localStorage.getItem(STORAGE_LAST_GAME_ID_KEY);
      const savedSlotStr = localStorage.getItem(STORAGE_LAST_SLOT_KEY);

      if (!savedGameId || savedSlotStr == null) {
        setStatus("Not in a game. Create or join to start.");
        return;
      }

      currentPlayerId = getOrCreatePlayerId();
      currentGameId = savedGameId;
      currentPlayerSlot = parseInt(savedSlotStr, 10);

      const docRef = db.collection("games").doc(savedGameId);
      const snap = await docRef.get();

      if (!snap.exists) {
        // stale reference
        localStorage.removeItem(STORAGE_LAST_GAME_ID_KEY);
        localStorage.removeItem(STORAGE_LAST_SLOT_KEY);
        currentGameId = null;
        currentPlayerSlot = null;
        setStatus("Last saved game not found. Create or join a new one.");
        enableScorecard(false);
        return;
      }

      setStatus("Rejoined your last game. Enter scores as normal.");

      if (unsubscribeGame) unsubscribeGame();
      unsubscribeGame = docRef.onSnapshot(s => {
        if (!s.exists) {
          setStatus("Game was deleted or not found.", true);
          enableScorecard(false);
          return;
        }
        applyGameToUI(s.data());
        enableScorecard(true);
      });
    }

    // theme and rules
    themeSwitch.addEventListener("change", () => {
      if (themeSwitch.checked) {
        body.classList.add("dark");
      } else {
        body.classList.remove("dark");
      }
    });

    rulesLink.addEventListener("click", () => {
      const isVisible = rulesCard.classList.contains("visible");
      if (isVisible) {
        rulesCard.classList.remove("visible");
        rulesLink.textContent = "View Pardle Rules";
      } else {
        rulesCard.classList.add("visible");
        rulesLink.textContent = "Hide Pardle Rules";
        rulesCard.scrollIntoView({ behavior: "smooth", block: "start" });
      }
    });

    // event wiring and initial setup
    createGameBtn.addEventListener("click", () => {
      createGame().catch(err => {
        console.error(err);
        setStatus("Error creating game.", true);
      });
    });

    joinGameBtn.addEventListener("click", () => {
      joinGame().catch(err => {
        console.error(err);
        setStatus("Error joining game.", true);
      });
    });

    // Initial setup
    bindScoreInputs();
    updateParRow();
    enableScorecard(false);
    // try to auto-attach to last game if one exists
    attemptAutoRejoin().catch(err => {
      console.error(err);
      setStatus("Not in a game. Create or join to start.");
    });
  </script>
</body>
</html>
