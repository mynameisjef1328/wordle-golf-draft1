<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pardle</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <style>
    :root {
      /* default: light mode, normal accents */
      --bg: #f5f5f5;
      --bg-card: #ffffff;
      --text: #111111;
      --accent: #ff9800;
      --accent-soft: #ffe0b2;
      --border-soft: #dddddd;
      --header-bg: #ffffff;
      --sync-bg: #00c853;
      --sync-text: #ffffff;
      --table-header-bg: #e0e0e0;
      --table-header-text: #111111;
      --table-player-header-bg: #000000;
      --table-player-header-text: #ffffff;
      --input-bg: #ffffff;
      --input-text: #000000;
      --par-bg: #cde8cf;
      --active-hole-bg: rgba(255, 152, 0, 0.14);
    }

    /* Dark mode overrides */
    body[data-mode="dark"] {
      --bg: #101010;
      --bg-card: #181818;
      --text: #f5f5f5;
      --accent: #ff9800;
      --accent-soft: #664200;
      --border-soft: #333333;
      --header-bg: #181818;
      --sync-bg: #00c853;
      --sync-text: #ffffff;
      --table-header-bg: #333333;
      --table-header-text: #ffffff;
      --input-bg: #202020;
      --input-text: #ffffff;
      --par-bg: #2e3b2f;
      --active-hole-bg: rgba(255, 152, 0, 0.24);
    }

    /* Accent invert: green primary, orange sync */
    body[data-accent="invert"] {
      --accent: #00c853;
      --accent-soft: #b9f6ca;
      --sync-bg: #ff9800;
      --sync-text: #111111;
    }

    * {
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text);
    }

    .app-shell {
      max-width: 480px;
      margin: 0 auto;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 12px 12px 24px;
      gap: 12px;
    }

    /* Start screen overlay */
    #startModal {
      position: fixed;
      inset: 0;
      background: #000000;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
      transition: opacity 0.25s ease, transform 0.25s ease;
    }

    #startModal.hidden {
      opacity: 0;
      pointer-events: none;
      transform: scale(1.02);
    }

    .start-card {
      background: #181818;
      border-radius: 18px;
      padding: 32px 40px 26px;
      box-shadow: 0 18px 45px rgba(0,0,0,0.6);
      border: 1px solid #232323;
      max-width: 360px;
      width: 90%;
      text-align: center;
    }

    .start-title {
      font-size: 28px;
      font-weight: 800;
      margin-bottom: 24px;
      letter-spacing: 0.02em;
    }

    .start-main-btn {
      width: 100%;
      padding: 12px 18px;
      border-radius: 999px;
      border: none;
      background: var(--accent);
      color: #ffffff;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 8px 20px rgba(0,0,0,0.4);
      margin-bottom: 12px;
      transition: transform 0.12s ease, box-shadow 0.12s ease, opacity 0.12s ease;
    }

    .start-main-btn:active {
      transform: scale(0.97);
      opacity: 0.9;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    }

    .start-join-link {
      border: none;
      background: none;
      color: #d0d0d0;
      font-size: 14px;
      cursor: pointer;
      text-decoration: underline;
      padding: 0;
      margin-bottom: 8px;
    }

    .start-join-link:active {
      opacity: 0.7;
    }

    .start-rules-btn {
      width: 100%;
      margin-top: 4px;
      padding: 10px 18px;
      border-radius: 999px;
      border: none;
      background: var(--sync-bg);
      color: #000000;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 6px 16px rgba(0,0,0,0.5);
      transition: transform 0.12s ease, box-shadow 0.12s ease, opacity 0.12s ease;
    }

    .start-rules-btn:active {
      transform: scale(0.97);
      opacity: 0.9;
      box-shadow: 0 3px 10px rgba(0,0,0,0.6);
    }

    .app-header {
      background: var(--bg-card);
      padding: 10px 16px;
      border-radius: 14px;
      border: 1px solid var(--border-soft);
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .app-title {
      font-size: 20px;
      font-weight: 700;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .icon-btn {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      border: none;
      background: transparent;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      padding: 0;
      outline: none;
      transition: background 0.12s ease, transform 0.12s ease, box-shadow 0.12s ease;
    }

    .icon-btn:active {
      transform: scale(0.95);
      opacity: 0.85;
    }

    .icon-btn:hover {
      background: rgba(0,0,0,0.04);
    }

    body[data-mode="dark"] .icon-btn:hover {
      background: rgba(255,255,255,0.05);
    }

    .icon-btn-gear span {
      font-size: 33px;
      color: var(--sync-bg);
    }

    .icon-btn-analytics {
      gap: 2px;
      position: relative;
      top: 3px;
    }

    .icon-btn-analytics .bar {
      display: inline-block;
      width: 4px;
      border-radius: 999px;
      background: var(--sync-bg);
    }

    .icon-btn-analytics .bar.left {
      height: 10px;
    }
    .icon-btn-analytics .bar.middle {
      height: 16px;
    }
    .icon-btn-analytics .bar.right {
      height: 10px;
    }

    .pardle-pill {
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
    }

    .sync-pill {
      background: var(--sync-bg);
      color: var(--sync-text);
    }

    .app-content {
      display: flex;
      flex-direction: column;
      gap: 12px;
      flex: 1;
    }

    .card {
      background: var(--bg-card);
      border-radius: 14px;
      padding: 12px;
      border: 1px solid var(--border-soft);
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }

    .section-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    /* online controls */
    .online-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
      font-size: 13px;
    }

    .online-row {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .online-row label {
      min-width: 80px;
      font-size: 14px;
    }

    .online-input {
      flex: 1;
      min-width: 0;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      background: var(--input-bg);
      color: var(--input-text);
      font-size: 16px;
    }

    .online-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .small-btn {
      padding: 8px 10px;
      border-radius: 999px;
      border: none;
      background: var(--accent);
      color: #ffffff;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      flex: 1;
      min-width: 0;
      text-align: center;
    }

    .small-btn.secondary {
      background: var(--accent-soft);
      color: #000000;
    }

    .online-status {
      font-size: 12px;
      line-height: 1.4;
      color: #555;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .online-status.error-text {
      color: #d32f2f;
    }

    .online-status strong {
      color: var(--text);
    }

    .gameid-pill {
      align-self: flex-start;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      padding: 4px 10px;
      background: var(--bg-card);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      cursor: pointer;
    }

    .gameid-pill .icon {
      font-size: 12px;
      opacity: 0.8;
    }

    .gameid-pill:active {
      transform: scale(0.97);
      opacity: 0.85;
    }

    /* course selector */
    .course-row {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .course-select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      font-size: 16px;
      background: var(--input-bg);
      color: var(--input-text);
    }

    /* scorecard */
    .scorecard-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }

    .scorecard-header .section-title {
      margin-bottom: 0;
    }

    .chat-btn {
      border: none;
      background: var(--accent);
      color: #ffffff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.18);
      cursor: pointer;
      position: relative;
      gap: 4px;
      transition: transform 0.12s ease, box-shadow 0.12s ease;
    }

    .chat-btn:active {
      transform: scale(0.96);
      opacity: 0.85;
    }

    .chat-badge {
      position: absolute;
      top: -2px;
      right: -2px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #2ecc71;
      display: none;
    }

    .scorecard-wrapper {
      position: relative;
      border-radius: 14px;
      overflow: hidden;
      background: var(--bg-card);
    }

    .scorecard-scroll {
      overflow-x: auto;
      padding-bottom: 4px;
    }

    .scorecard-table {
      border-collapse: collapse;
      min-width: 1000px;
      width: 100%;
      font-size: 13px;
    }

    .scorecard-table th,
    .scorecard-table td {
      border: 1px solid var(--border-soft);
      text-align: center;
      vertical-align: middle;
      padding: 6px 4px;
      white-space: nowrap;
      transition: background 0.15s ease, box-shadow 0.15s ease;
    }

    .scorecard-table th.course-label {
      background: var(--table-header-bg);
      color: var(--table-header-text);
      text-align: left;
      padding-left: 8px;
      position: sticky;
      left: 0;
      z-index: 3;
    }

    .scorecard-table th.player-label {
      background: var(--table-player-header-bg);
      color: var(--table-player-header-text);
      text-align: left;
      padding-left: 8px;
      position: sticky;
      left: 0;
      z-index: 3;
    }

    .scorecard-table th.hole-header {
      background: var(--table-header-bg);
      color: var(--table-header-text);
      font-weight: 600;
    }

    .hole-header.active-hole,
    .scorecard-table td.active-hole {
      background: var(--active-hole-bg);
      box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.04);
    }

    .par-cell {
      background: var(--par-bg);
      font-weight: 600;
    }

    .score-input {
      width: 34px;
      height: 30px;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      background: var(--input-bg);
      color: var(--input-text);
      text-align: center;
      font-size: 16px;
      font-weight: 600;
    }

    .score-input:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .player-name {
      width: 100%;
      border: none;
      background: transparent;
      color: var(--table-player-header-text);
      text-align: left;
      padding: 0;
      font-weight: 500;
      font-size: 16px;
    }

    .player-name:disabled {
      opacity: 0.7;
    }

    .player-row + .player-row th.player-label,
    .player-row + .player-row td {
      border-top-width: 2px;
    }

    .total-col {
      background: #212121;
      color: #ffffff;
      font-weight: 700;
      min-width: 52px;
      font-size: 14px;
    }

    .player-row.saved-pulse td,
    .player-row.saved-pulse th.player-label {
      animation: savedPulse 0.35s ease-out;
    }

    @keyframes savedPulse {
      0% { background-color: var(--active-hole-bg); }
      100% { background-color: transparent; }
    }

    .swipe-hint {
      margin-top: 6px;
      font-size: 11px;
      text-align: right;
      opacity: 0.7;
    }

    .rules-card {
      display: none;
    }

    #rulesCard .rules-text h2 {
      margin-top: 6px;
      margin-bottom: 10px;
    }

       #rulesCard .rules-text h3 {
      margin-top: 14px;
      margin-bottom: 6px;
      color: var(--accent);
    } 

    #rulesCard .rules-text p {
      margin: 6px 0;
    }

    #rulesCard .rules-text ul {
      margin: 6px 0 6px 20px;
      padding-left: 0;
    }

    #rulesCard .rules-text li {
      margin: 3px 0;
    }

    .rules-card.visible {
      display: block;
    }

    .rules-text {
      font-size: 13px;
      line-height: 1.45;
    }

    /* generic bottom sheet styling */
    .chat-sheet {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: none;
      align-items: flex-end;
      justify-content: center;
      z-index: 20;
    }

    .chat-sheet.visible {
      display: flex;
    }

    .chat-sheet-inner {
      width: 100%;
      max-width: 480px;
      background: var(--bg-card);
      border-radius: 16px 16px 0 0;
      padding: 12px;
      border-top: 1px solid var(--border-soft);
      max-height: 85vh;
      overflow-y: auto;
    }

    .sheet-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-size: 14px;
      font-weight: 600;
    }

    .sheet-header-row button {
      border: none;
      background: none;
      font-size: 18px;
      cursor: pointer;
      color: var(--text);
    }

    /* chat specific */
    .chat-thread {
      max-height: 180px;
      overflow-y: auto;
      padding: 6px 8px;
      margin-bottom: 8px;
      border-radius: 8px;
      background: rgba(0,0,0,0.03);
      font-size: 12px;
    }

    body[data-mode="dark"] .chat-thread {
      background: rgba(255,255,255,0.04);
    }

    .chat-message {
      margin-bottom: 4px;
      display: flex;
      flex-direction: column;
    }

    .chat-message.me {
      text-align: right;
    }

    .chat-message span.meta {
      font-size: 11px;
      opacity: 0.7;
    }

    .chat-message span.text {
      font-size: 12px;
    }

    .chat-input {
      width: 100%;
      min-height: 60px;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      padding: 6px 8px;
      font-size: 16px;
      margin-bottom: 8px;
      background: var(--input-bg);
      color: var(--input-text);
      resize: vertical;
    }

    .chat-actions {
      display: flex;
      gap: 8px;
    }

    .chat-targets {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
    }

    .chat-target-pill {
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
      background: var(--bg-card);
      color: var(--text);
    }

    .chat-target-pill.selected {
      background: var(--accent-soft);
      border-color: var(--accent);
    }

    /* settings sheet */
    .settings-section {
      margin-bottom: 12px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border-soft);
    }

    .settings-section:last-of-type {
      border-bottom: none;
    }

    .settings-label {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .settings-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .settings-link-btn {
      border: none;
      background: none;
      padding: 0;
      font-size: 13px;
      font-weight: 600;
      color: var(--accent);
      cursor: pointer;
    }

    .theme-toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      position: relative;
    }

    .theme-toggle span.label {
      font-size: 13px;
    }

    .theme-toggle input {
      opacity: 0;
      width: 0;
      height: 0;
      position: absolute;
    }

    .theme-toggle .slider {
      width: 40px;
      height: 20px;
      border-radius: 999px;
      background: #cccccc;
      position: relative;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .theme-toggle .slider::before {
      content: "";
      position: absolute;
      width: 16px;
      height: 16px;
      left: 2px;
      top: 2px;
      border-radius: 50%;
      background: #ffffff;
      transition: transform 0.2s ease;
    }

    .theme-toggle input:checked + .slider {
      background: #000000;
    }

    .theme-toggle input:checked + .slider::before {
      transform: translateX(20px);
    }

    /* analytics sheet */
    .analytics-intro {
      font-size: 13px;
      line-height: 1.4;
      margin-bottom: 10px;
    }

    .analytics-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 13px;
    }

    .analytics-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 8px;
      border-radius: 10px;
      background: rgba(0,0,0,0.03);
    }

    body[data-mode="dark"] .analytics-row {
      background: rgba(255,255,255,0.04);
    }

    .analytics-name {
      font-weight: 600;
    }

    .analytics-score {
      font-weight: 700;
    }

    /* New game confirmation modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 30;
    }

    .modal-backdrop.visible {
      display: flex;
    }

    .modal-card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 14px 16px 12px;
      max-width: 320px;
      width: 90%;
      box-shadow: 0 4px 12px rgba(0,0,0,0.18);
      border: 1px solid var(--border-soft);
    }

    .modal-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .modal-body {
      font-size: 13px;
      line-height: 1.4;
      margin-bottom: 12px;
    }

    .modal-actions {
      display: flex;
      gap: 8px;
      margin-top: 4px;
    }

    .modal-actions .small-btn {
      flex: 1;
    }

    .modal-actions .secondary {
      background: var(--accent-soft);
      color: #000000;
    }

    @media (min-width: 520px) {
      .app-shell {
        padding-inline: 16px;
      }
    }
  </style>
</head>
<body data-mode="dark" data-accent="normal">

  <!-- Start screen overlay -->
  <div id="startModal">
    <div class="start-card">
      <div class="start-title">Pardle</div>
      <button id="startPlayButton" class="start-main-btn" type="button">Play</button>
      <button id="startJoinLink" class="start-join-link" type="button">Join Game</button>
      <button id="startRulesButton" class="start-rules-btn" type="button">Game Rules</button>
    </div>
  </div>

  <div class="app-shell">
    <header class="app-header">
      <div class="app-title">Pardle</div>
      <div class="header-actions">
        <button id="analyticsButton" class="icon-btn icon-btn-analytics" type="button" aria-label="View round stats">
          <span class="bar left"></span>
          <span class="bar middle"></span>
          <span class="bar right"></span>
        </button>
        <button id="settingsButton" class="icon-btn icon-btn-gear" type="button" aria-label="Settings">
          <span>‚öôÔ∏é</span>
        </button>
      </div>
    </header>

    <main class="app-content">
      <!-- Online game controls -->
      <section class="card">
        <div class="online-grid">
          <div class="online-row">
            <label for="playerNameInput">Your name</label>
            <input id="playerNameInput" class="online-input" placeholder="Name" />
          </div>

          <div class="online-row online-buttons">
            <button id="createGameBtn" class="small-btn" type="button">Create Game</button>
            <input id="joinGameIdInput" class="online-input" placeholder="Enter ID" />
            <button id="joinGameBtn" class="small-btn secondary" type="button">Join Game</button>
          </div>

          <div class="online-status" id="onlineStatusText">
            <button class="gameid-pill" id="gameIdPill" type="button">
              <span class="icon">‚ßâ</span>
              <span id="gameIdValue">none</span>
            </button>
            <span id="statusMessage">Not in a game. Create or join to start.</span>
          </div>
        </div>
      </section>

      <!-- Course selector -->
      <section class="card">
        <div class="section-title">Course</div>
        <div class="course-row">
          <select class="course-select" id="courseSelect" disabled>
            <option value="st-andrews">St. Androos Links</option>
            <option value="augusta">Azalea National</option>
            <option value="bully-pulpit">Badlands Pulpit</option>
            <option value="torrey-pines">Torrey Pints</option>
            <option value="bethpage-black">Bethpage Back Tees</option>
            <option value="sweetwater">Sweetwater Country Klub</option>
            <option value="tpc-sawgrass">TPC Strawgrass</option>
            <option value="whistling-straits">Whistling Straights</option>
            <option value="pebble-beach">Pebble Reach</option>
            <option value="congressional">Congress-ish National</option>
          </select>
        </div>
      </section>

      <!-- Scorecard -->
      <section class="card">
        <div class="scorecard-header">
          <div class="section-title">Scorecard</div>
          <button id="chatButton" class="chat-btn pardle-pill" type="button">
            üí¨ Chat
            <span id="chatBadge" class="chat-badge"></span>
          </button>
        </div>

        <div class="scorecard-wrapper">
          <div class="scorecard-scroll">
            <table class="scorecard-table">
              <thead>
                <tr>
                  <th class="course-label">Course</th>
                  <th class="hole-header">1</th>
                  <th class="hole-header">2</th>
                  <th class="hole-header">3</th>
                  <th class="hole-header">4</th>
                  <th class="hole-header">5</th>
                  <th class="hole-header">6</th>
                  <th class="hole-header">7</th>
                  <th class="hole-header">8</th>
                  <th class="hole-header">9</th>
                  <th class="hole-header">10</th>
                  <th class="hole-header">11</th>
                  <th class="hole-header">12</th>
                  <th class="hole-header">13</th>
                  <th class="hole-header">14</th>
                  <th class="hole-header">15</th>
                  <th class="hole-header">16</th>
                  <th class="hole-header">17</th>
                  <th class="hole-header">18</th>
                  <th class="hole-header">Total</th>
                </tr>
              </thead>
              <tbody>
                <tr id="parRow">
                  <th class="course-label">Par</th>
                  <td class="par-cell" data-hole="0"></td>
                  <td class="par-cell" data-hole="1"></td>
                  <td class="par-cell" data-hole="2"></td>
                  <td class="par-cell" data-hole="3"></td>
                  <td class="par-cell" data-hole="4"></td>
                  <td class="par-cell" data-hole="5"></td>
                  <td class="par-cell" data-hole="6"></td>
                  <td class="par-cell" data-hole="7"></td>
                  <td class="par-cell" data-hole="8"></td>
                  <td class="par-cell" data-hole="9"></td>
                  <td class="par-cell" data-hole="10"></td>
                  <td class="par-cell" data-hole="11"></td>
                  <td class="par-cell" data-hole="12"></td>
                  <td class="par-cell" data-hole="13"></td>
                  <td class="par-cell" data-hole="14"></td>
                  <td class="par-cell" data-hole="15"></td>
                  <td class="par-cell" data-hole="16"></td>
                  <td class="par-cell" data-hole="17"></td>
                  <td class="par-cell par-total">-</td>
                </tr>

                <!-- Player rows -->
                <tr class="player-row" data-slot="0">
                  <th class="player-label">
                    <input class="player-name" placeholder="Player 1" disabled />
                  </th>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td class="total-col">E</td>
                </tr>
                <tr class="player-row" data-slot="1">
                  <th class="player-label">
                    <input class="player-name" placeholder="Player 2" disabled />
                  </th>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td class="total-col">E</td>
                </tr>
                <tr class="player-row" data-slot="2">
                  <th class="player-label">
                    <input class="player-name" placeholder="Player 3" disabled />
                  </th>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td class="total-col">E</td>
                </tr>
                <tr class="player-row" data-slot="3">
                  <th class="player-label">
                    <input class="player-name" placeholder="+ Add Player" disabled />
                  </th>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td><input class="score-input" type="number" min="1" disabled /></td>
                  <td class="total-col">E</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <p class="swipe-hint">Swipe sideways to see all holes ‚ü∂</p>
      </section>

      <!-- Rules card -->
      <section class="card rules-card" id="rulesCard">
        <div class="section-title">Follow The Rules Or Follow The Fools</div>
        <div class="rules-text">
          <h2>PARDLE RULES</h2>
          <p>Pardle is what happens when Wordle and golf have a beautiful, competitive baby.</p>

          <h3>The Basics</h3>
          <ul>
            <li>Each ‚Äúhole‚Äù is one Wordle puzzle.</li>
            <li>Your score for the hole equals the number of guesses it took you to solve that day‚Äôs Wordle.</li>
            <li>Did not crack it? Mark it as a 7 or an ‚ÄúX‚Äù (just make sure your group agrees).</li>
            <li>Par is the number of guesses you are aiming for.</li>
          </ul>

          <h3>Scoring</h3>
          <ul>
            <li>Your total score is the sum of guesses across all holes in the round.</li>
            <li>Relative score equals total score vs. par. Lower is better.</li>
            <li>
              Score breakdown:
              <ul>
                <li>‚ÄúE‚Äù equals even with par</li>
                <li>‚Äú+2‚Äù equals two over par</li>
                <li>‚Äú-1‚Äù equals one under par</li>
              </ul>
            </li>
          </ul>

          <p>Pardle is perfect for tracking daily scores with your crew, flexing your vocab game, and delivering top tier trash talk.</p>

<div class="start-help">
  <p><h3>Not sure which to tap?</h3></p>
  <p><strong>Play Button</strong><br>
    Use this if you are the one setting up the match or coming back on the same device you used last time.<br>
    ‚Ä¢ If you already have a Pardle game on this device, it will reopen that game.<br>
    ‚Ä¢ If you do not have a game yet, you will go to the main screen where you can tap <strong>Create Game</strong> and get a game code to share.
  </p>
  <p><strong>Join Game Link</strong><br>
    Use this if someone else already created a game and sent you a game code.<br>
    ‚Ä¢ Tap <strong>Join Game</strong>.<br>
    ‚Ä¢ Enter the code they gave you.<br>
    ‚Ä¢ You will join their existing match on this device.
  </p>
</div>
</section>
</main>

    <!-- Chat sheet -->
    <div id="chatSheet" class="chat-sheet">
      <div class="chat-sheet-inner">
        <div class="sheet-header-row">
          <span>Game chat</span>
          <button id="chatCloseBtn" type="button">‚úï</button>
        </div>
        <div id="chatTargets" class="chat-targets"></div>
        <div id="chatThread" class="chat-thread"></div>
        <textarea id="chatText" class="chat-input" placeholder="Type your masterpiece‚Ä¶"></textarea>
        <div class="chat-actions">
          <button id="chatCancelBtn" class="small-btn secondary" type="button">Cancel</button>
          <button id="chatSendBtn" class="small-btn" type="button">Send</button>
        </div>
      </div>
    </div>

    <!-- Settings sheet -->
    <div id="settingsSheet" class="chat-sheet">
      <div class="chat-sheet-inner">
        <div class="sheet-header-row">
          <span>Settings</span>
          <button id="settingsCloseBtn" type="button">‚úï</button>
        </div>

        <div class="settings-section">
          <div class="settings-label">Appearance</div>
          <div class="settings-row" style="margin-bottom:6px;">
            <span style="font-size:13px;">Theme</span>
            <label class="theme-toggle">
              <span class="label">Dark</span>
              <input type="checkbox" id="themeSwitch" />
              <span class="slider"></span>
            </label>
          </div>
          <div class="settings-row">
            <span style="font-size:13px;">Invert accents</span>
            <label class="theme-toggle">
              <span class="label">On</span>
              <input type="checkbox" id="accentSwitch" />
              <span class="slider"></span>
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- Analytics sheet -->
    <div id="analyticsSheet" class="chat-sheet">
      <div class="chat-sheet-inner">
        <div class="sheet-header-row">
          <span>Round stats</span>
          <button id="analyticsCloseBtn" type="button">‚úï</button>
        </div>
        <p class="analytics-intro">
          Pardle handicap and deeper analytics are coming soon. For now, here is a quick summary of this round.
        </p>
        <div id="analyticsList" class="analytics-list"></div>
      </div>
    </div>

    <!-- New Game confirmation modal -->
    <div id="newGameConfirm" class="modal-backdrop">
      <div class="modal-card">
        <div class="modal-title">Start a new game?</div>
        <div class="modal-body">
          <p>This will clear all player names and scores on this device.</p>
          <p>If you are mid round, tap Cancel. If you are ready to wipe the slate and that triple bogey, tap Start New Game.</p>
        </div>
        <div class="modal-actions">
          <button id="newGameCancelBtn" class="small-btn secondary" type="button">Cancel</button>
          <button id="newGameConfirmBtn" class="small-btn" type="button">Start New Game</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ==============================
    // Firebase setup
    // ==============================
    const firebaseConfig = {
      apiKey: "AIzaSyDxmmTSpvM1xvVRb8qiOQfbbQWHSJEgIrk",
      authDomain: "pardle-online.firebaseapp.com",
      projectId: "pardle-online",
      storageBucket: "pardle-online.firebasestorage.app",
      messagingSenderId: "552026596516",
      appId: "1:552026596516:web:779d08f94ef455eda7f231",
      measurementId: "G-SJLZZ84L8F"
    };

    let db = null;
    try {
      firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();
    } catch (e) {
      console.error("Firebase init error:", e);
    }

    // ==============================
    // Constants and state
    // ==============================
    const STORAGE_PLAYER_ID_KEY = "pardle_online_player_id";
    const STORAGE_LAST_GAME_ID_KEY = "pardle_online_last_game_id";
    const STORAGE_LAST_SLOT_KEY = "pardle_online_last_player_slot";
    const STORAGE_MODE_KEY = "pardle_mode";
    const STORAGE_ACCENT_KEY = "pardle_accent";

    const COURSES = {
      "st-andrews": [4,4,4,4,5,4,4,3,4,4,3,4,4,5,4,4,4,4],
      "augusta": [4,5,4,3,4,3,4,5,4,4,4,3,5,4,5,3,4,4],
      "bully-pulpit": [4,4,4,5,5,3,4,3,4,4,5,3,4,4,3,4,5,4],
      "torrey-pines": [4,4,3,4,5,4,4,3,5,5,4,3,4,4,3,4,5,4],
      "bethpage-black": [4,4,3,5,4,4,5,3,4,4,4,4,5,3,4,4,3,4],
      "sweetwater": [4,4,3,4,5,3,4,4,3,4,4,3,4,5,3,4,4,3],
      "tpc-sawgrass": [4,5,3,4,4,4,4,3,5,4,5,4,3,4,4,5,3,4],
      "whistling-straits": [4,5,3,4,5,4,3,4,4,4,5,3,4,4,4,5,3,4],
      "pebble-beach": [4,5,4,4,3,5,3,4,4,4,4,3,4,5,4,4,3,5],
      "congressional": [4,3,4,5,4,5,3,4,5,3,5,4,3,4,5,5,4,4]
    };

    const MAX_PLAYERS = 4;
    const HOLES = 18;

    let currentGameId = null;
    let currentPlayerId = null;
    let currentPlayerSlot = null;
    let currentGameData = null;
    let unsubscribeGame = null;
    let unsubscribeMessages = null;
    let hasUnreadMessages = false;
    let messagesInitialized = false;

    // ==============================
    // DOM references
    // ==============================
    const body = document.body;

    const startModal = document.getElementById("startModal");
    const startPlayButton = document.getElementById("startPlayButton");
    const startJoinLink = document.getElementById("startJoinLink");
    const startRulesButton = document.getElementById("startRulesButton");

    const playerNameInput = document.getElementById("playerNameInput");
    const createGameBtn = document.getElementById("createGameBtn");
    const joinGameBtn = document.getElementById("joinGameBtn");
    const joinGameIdInput = document.getElementById("joinGameIdInput");
    const onlineStatusText = document.getElementById("onlineStatusText");
    const gameIdPill = document.getElementById("gameIdPill");
    const gameIdValue = document.getElementById("gameIdValue");
    const statusMessage = document.getElementById("statusMessage");

    const courseSelect = document.getElementById("courseSelect");
    const parCells = document.querySelectorAll(".par-cell[data-hole]");
    const parTotalCell = document.querySelector(".par-total");
    const playerRows = document.querySelectorAll(".player-row");

    const chatButton = document.getElementById("chatButton");
    const chatBadge = document.getElementById("chatBadge");
    const chatSheet = document.getElementById("chatSheet");
    const chatCloseBtn = document.getElementById("chatCloseBtn");
    const chatCancelBtn = document.getElementById("chatCancelBtn");
    const chatTargets = document.getElementById("chatTargets");
    const chatThread = document.getElementById("chatThread");
    const chatText = document.getElementById("chatText");
    const chatSendBtn = document.getElementById("chatSendBtn");

    const newGameConfirm = document.getElementById("newGameConfirm");
    const newGameCancelBtn = document.getElementById("newGameCancelBtn");
    const newGameConfirmBtn = document.getElementById("newGameConfirmBtn");

    const settingsButton = document.getElementById("settingsButton");
    const settingsSheet = document.getElementById("settingsSheet");
    const settingsCloseBtn = document.getElementById("settingsCloseBtn");
    const themeSwitch = document.getElementById("themeSwitch");
    const accentSwitch = document.getElementById("accentSwitch");

    const rulesCard = document.getElementById("rulesCard");

    const analyticsButton = document.getElementById("analyticsButton");
    const analyticsSheet = document.getElementById("analyticsSheet");
    const analyticsCloseBtn = document.getElementById("analyticsCloseBtn");
    const analyticsList = document.getElementById("analyticsList");

    // ==============================
    // Appearance init
    // ==============================
    (function initAppearance() {
      const savedMode = localStorage.getItem(STORAGE_MODE_KEY) || "dark";
      const savedAccent = localStorage.getItem(STORAGE_ACCENT_KEY) || "normal";
      body.dataset.mode = savedMode;
      body.dataset.accent = savedAccent;
      if (themeSwitch) themeSwitch.checked = savedMode === "dark";
      if (accentSwitch) accentSwitch.checked = savedAccent === "invert";
    })();

    // ==============================
    // Helpers
    // ==============================
    function generateId(len = 20) {
      const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
      let out = "";
      for (let i = 0; i < len; i++) {
        out += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return out;
    }

    function getOrCreatePlayerId() {
      let id = localStorage.getItem(STORAGE_PLAYER_ID_KEY);
      if (!id) {
        id = generateId(16);
        localStorage.setItem(STORAGE_PLAYER_ID_KEY, id);
      }
      return id;
    }

    function setStatus(msg, isError = false) {
      const gameIdText = currentGameId || "none";

      if (gameIdValue) {
        gameIdValue.textContent = gameIdText;
      }
      if (statusMessage) {
        statusMessage.textContent = msg;
      }

      if (isError) {
        onlineStatusText.classList.add("error-text");
      } else {
        onlineStatusText.classList.remove("error-text");
      }
    }

    function enableScorecard(enabled) {
      courseSelect.disabled = !enabled;
      playerRows.forEach(row => {
        const slot = parseInt(row.dataset.slot, 10);
        const isMine = enabled && currentPlayerSlot === slot;
        const nameInput = row.querySelector(".player-name");
        const scoreInputs = row.querySelectorAll(".score-input");
        nameInput.disabled = !isMine;
        scoreInputs.forEach(inp => inp.disabled = !isMine);
      });
    }

    function scrollChatToBottom() {
      if (!chatThread) return;
      chatThread.scrollTop = chatThread.scrollHeight;
    }

    function updateParRow() {
      const courseId = currentGameData ? currentGameData.courseId : courseSelect.value;
      const pars = COURSES[courseId];
      if (!pars) return;

      let parTotal = 0;

      parCells.forEach(cell => {
        const idx = parseInt(cell.dataset.hole, 10);
        const value = pars[idx];
        if (typeof value === "number") {
          cell.textContent = value;
          parTotal += value;
        } else {
          cell.textContent = "";
        }
      });

      parTotalCell.textContent = parTotal > 0 ? parTotal : "-";
      recalcAllTotals();
    }

    function recalcAllTotals() {
      const courseId = currentGameData ? currentGameData.courseId : courseSelect.value;
      const pars = COURSES[courseId] || [];

      const rows = document.querySelectorAll("tbody tr");
      rows.forEach(row => {
        if (row.id === "parRow") return;

        const scoreInputs = row.querySelectorAll(".score-input");
        if (!scoreInputs.length) return;

        let scoreTotal = 0;
        let parTotalPlayed = 0;

        scoreInputs.forEach((input, idx) => {
          const val = parseInt(input.value, 10);
          if (!isNaN(val) && val > 0) {
            scoreTotal += val;
            const parVal = pars[idx];
            if (typeof parVal === "number") {
              parTotalPlayed += parVal;
            }
          }
        });

        const totalCell = row.querySelector(".total-col");
        if (!totalCell) return;

        if (scoreTotal === 0) {
          totalCell.textContent = "E";
          return;
        }

        if (parTotalPlayed === 0) {
          totalCell.textContent = String(scoreTotal);
          return;
        }

        const diff = scoreTotal - parTotalPlayed;
        if (diff === 0) {
          totalCell.textContent = "E";
        } else if (diff > 0) {
          totalCell.textContent = "+" + diff;
        } else {
          totalCell.textContent = diff.toString();
        }
      });
    }

    function readScoresFromSlot(slot) {
      const row = document.querySelector('.player-row[data-slot="' + slot + '"]');
      if (!row) return Array(HOLES).fill(null);

      const inputs = row.querySelectorAll(".score-input");
      const scores = [];
      inputs.forEach(inp => {
        const v = inp.value;
        scores.push(v === "" ? null : Number(v));
      });
      return scores;
    }

    function setActiveHole(holeIndex) {
      if (holeIndex < 0 || holeIndex >= HOLES) return;

      const headerRow = document.querySelector(".scorecard-table thead tr");
      if (!headerRow) return;

      headerRow.querySelectorAll(".hole-header").forEach(h => h.classList.remove("active-hole"));
      document.querySelectorAll(".scorecard-table td.active-hole").forEach(td => td.classList.remove("active-hole"));

      const headerCells = headerRow.querySelectorAll("th");
      const targetHeader = headerCells[1 + holeIndex];
      if (targetHeader) {
        targetHeader.classList.add("active-hole");
      }

      document.querySelectorAll(".scorecard-table tbody tr").forEach(row => {
        const cells = row.querySelectorAll("th, td");
        const targetCell = cells[1 + holeIndex];
        if (targetCell && targetCell.tagName === "TD") {
          targetCell.classList.add("active-hole");
        }
      });
    }

    function applyGameToUI(data) {
      if (!data) return;

      currentGameData = data;

      const courseId = data.courseId || "st-andrews";
      if (COURSES[courseId]) {
        courseSelect.value = courseId;
      }
      updateParRow();

      const players = Array.isArray(data.players) ? data.players : [];

      for (let i = 0; i < MAX_PLAYERS; i++) {
        const row = document.querySelector('.player-row[data-slot="' + i + '"]');
        if (!row) continue;
        const nameInput = row.querySelector(".player-name");
        const scoreInputs = row.querySelectorAll(".score-input");

        const p = players[i];
        if (p && p.id) {
          nameInput.value = p.name || "";
          const scores = Array.isArray(p.scores) ? p.scores : [];
          for (let h = 0; h < HOLES; h++) {
            if (!scoreInputs[h]) continue;
            const score = scores[h];
            scoreInputs[h].value = score == null ? "" : score;
          }
        } else {
          nameInput.value = "";
          scoreInputs.forEach(inp => inp.value = "");
        }
      }

      if (currentPlayerSlot != null && players[currentPlayerSlot]) {
        playerNameInput.value = players[currentPlayerSlot].name || "";
      }

      let holeForHighlight = 0;
      if (currentPlayerSlot != null) {
        const myRow = document.querySelector('.player-row[data-slot="' + currentPlayerSlot + '"]');
        if (myRow) {
          const myInputs = myRow.querySelectorAll(".score-input");
          let firstEmpty = -1;

          for (let i = 0; i < myInputs.length; i++) {
            if (!myInputs[i].value) {
              firstEmpty = i;
              break;
            }
          }

          if (firstEmpty !== -1) {
            holeForHighlight = firstEmpty;
          } else if (myInputs.length > 0) {
            holeForHighlight = myInputs.length - 1;
          }
        }
      }

      setActiveHole(holeForHighlight);
      recalcAllTotals();
      renderChatTargets();
    }

    function setUnreadBadge(flag) {
      hasUnreadMessages = flag;
      if (!chatBadge) return;
      chatBadge.style.display = flag ? "inline-block" : "none";
    }

    // ==============================
    // Score input binding
    // ==============================
    function bindScoreInputs() {
      playerRows.forEach(row => {
        const slot = parseInt(row.dataset.slot, 10);
        const nameInput = row.querySelector(".player-name");
        const scoreInputs = row.querySelectorAll(".score-input");

        nameInput.addEventListener("input", () => {
          if (currentGameId && currentPlayerSlot === slot) {
            updatePlayerInGame();
          }
        });

        scoreInputs.forEach(inp => {
          inp.addEventListener("focus", () => {
            const cell = inp.closest("td");
            if (!cell) return;
            const rowEl = cell.parentElement;
            const allCells = Array.from(rowEl.querySelectorAll("th, td"));
            const holeIndex = allCells.indexOf(cell) - 1;
            if (holeIndex >= 0 && holeIndex < HOLES) {
              setActiveHole(holeIndex);
            }
          });

          inp.addEventListener("input", () => {
            if (currentGameId && currentPlayerSlot === slot) {
              updatePlayerInGame();
            }
          });

          // over par logic
          inp.addEventListener("change", () => {
            const raw = inp.value;
            const score = parseInt(raw, 10);
            if (isNaN(score) || score <= 0) return;

            const cell = inp.closest("td");
            if (!cell) return;
            const rowEl = cell.parentElement;
            const allCells = Array.from(rowEl.querySelectorAll("th, td"));
            const holeIndex = allCells.indexOf(cell) - 1;
            if (holeIndex < 0 || holeIndex >= HOLES) return;

            const courseId = currentGameData ? currentGameData.courseId : courseSelect.value;
            const pars = COURSES[courseId];
            if (!pars) return;

            const parVal = pars[holeIndex];
            if (typeof parVal !== "number") return;

            if (score > parVal) {
              const diff = score - parVal;
              alert("Bruh. " + score + " on a par " + parVal + " is " + diff + " over. That is rough. Do better.");
            }
          });
        });
      });

      courseSelect.addEventListener("change", () => {
        if (!currentGameId || !currentGameData) {
          updateParRow();
          return;
        }
        const newCourseId = courseSelect.value;
        const updated = Object.assign({}, currentGameData, { courseId: newCourseId });
        currentGameData = updated;
        if (!db) return;
        db.collection("games").doc(currentGameId).set(updated);
      });
    }

    // ==============================
    // Game create / join
    // ==============================
    async function updatePlayerInGame() {
      if (!db) {
        setStatus("Connection error. Reload the page to sync.", true);
        return;
      }
      if (!currentGameId || currentPlayerSlot == null || !currentGameData) return;

      const row = document.querySelector('.player-row[data-slot="' + currentPlayerSlot + '"]');
      if (!row) return;

      const nameInput = row.querySelector(".player-name");
      const scores = readScoresFromSlot(currentPlayerSlot);

      const updated = Object.assign({}, currentGameData);
      const players = Array.isArray(updated.players) ? updated.players.slice() : [];

      while (players.length < MAX_PLAYERS) {
        players.push({ id: null, name: "", scores: Array(HOLES).fill(null) });
      }

      players[currentPlayerSlot] = {
        id: currentPlayerId,
        name: nameInput.value || "",
        scores
      };

      updated.players = players;
      currentGameData = updated;

      await db.collection("games").doc(currentGameId).set(updated);
      recalcAllTotals();

      row.classList.remove("saved-pulse");
      void row.offsetWidth;
      row.classList.add("saved-pulse");
    }

    async function createGame() {
      if (!db) {
        setStatus("Connection error. Check your network and reload.", true);
        return;
      }

      const name = playerNameInput.value.trim();
      if (!name) {
        setStatus("Enter your name before creating a game.", true);
        return;
      }

      currentPlayerId = getOrCreatePlayerId();
      currentPlayerSlot = 0;

      const emptyScores = Array(HOLES).fill(null);
      const players = [];
      for (let i = 0; i < MAX_PLAYERS; i++) {
        players.push({ id: null, name: "", scores: emptyScores });
      }
      players[0] = { id: currentPlayerId, name, scores: emptyScores };

      const initialCourseId = courseSelect.value || "st-andrews";

      const docRef = await db.collection("games").add({
        courseId: initialCourseId,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        players
      });

      currentGameId = docRef.id;

      localStorage.setItem(STORAGE_LAST_GAME_ID_KEY, currentGameId);
      localStorage.setItem(STORAGE_LAST_SLOT_KEY, String(currentPlayerSlot));

      setStatus("Game created. Share this code with your friends.");

      if (unsubscribeGame) unsubscribeGame();
      unsubscribeGame = docRef.onSnapshot(snap => {
        if (!snap.exists) {
          setStatus("Game was deleted or not found.", true);
          enableScorecard(false);
          return;
        }
        applyGameToUI(snap.data());
        enableScorecard(true);
      });

      setUnreadBadge(false);
      messagesInitialized = false;
      attachMessageListener(currentGameId);
    }

    async function joinGame() {
      if (!db) {
        setStatus("Connection error. Check your network and reload.", true);
        return;
      }

      const name = playerNameInput.value.trim();
      if (!name) {
        setStatus("Enter your name before joining a game.", true);
        return;
      }

      const joinId = joinGameIdInput.value.trim();
      if (!joinId) {
        setStatus("Enter a game code to join.", true);
        return;
      }

      currentPlayerId = getOrCreatePlayerId();

      const docRef = db.collection("games").doc(joinId);
      const snap = await docRef.get();
      if (!snap.exists) {
        setStatus("Game not found. Check the code and try again.", true);
        return;
      }

      const data = snap.data() || {};
      let players = Array.isArray(data.players) ? data.players.slice() : [];
      while (players.length < MAX_PLAYERS) {
        players.push({ id: null, name: "", scores: Array(HOLES).fill(null) });
      }

      let slot = players.findIndex(p => p && p.id === currentPlayerId);

      if (slot === -1) {
        slot = players.findIndex(p => !p || !p.id);
        if (slot === -1) {
          setStatus("This game already has 4 players.", true);
          return;
        }

        const emptyScores = Array(HOLES).fill(null);
        players[slot] = {
          id: currentPlayerId,
          name,
          scores: emptyScores
        };
      } else {
        const existing = players[slot] || {};
        players[slot] = {
          id: existing.id || currentPlayerId,
          name: name || existing.name || "",
          scores: Array.isArray(existing.scores)
            ? existing.scores
            : Array(HOLES).fill(null)
        };
      }

      await docRef.set(
        Object.assign({}, data, { players })
      );

      currentGameId = joinId;
      currentPlayerSlot = slot;

      localStorage.setItem(STORAGE_LAST_GAME_ID_KEY, currentGameId);
      localStorage.setItem(STORAGE_LAST_SLOT_KEY, String(currentPlayerSlot));

      setStatus("Joined game in slot " + (slot + 1) + ".");

      if (unsubscribeGame) unsubscribeGame();
      unsubscribeGame = docRef.onSnapshot(s => {
        if (!s.exists) {
          setStatus("Game was deleted or not found.", true);
          enableScorecard(false);
          return;
        }
        applyGameToUI(s.data());
        enableScorecard(true);
      });

      setUnreadBadge(false);
      messagesInitialized = false;
      attachMessageListener(currentGameId);
    }

  async function attemptAutoRejoin() {
  const savedGameId = localStorage.getItem(STORAGE_LAST_GAME_ID_KEY);
  const savedSlotStr = localStorage.getItem(STORAGE_LAST_SLOT_KEY);

  if (!savedGameId) {
    setStatus("Not in a game. Create or join to start.");
    return;
  }

  currentPlayerId = getOrCreatePlayerId();
  currentGameId = savedGameId;

  const docRef = db.collection("games").doc(savedGameId);
  const snap = await docRef.get();

  if (!snap.exists) {
    // old game is gone, clean up and bail
    localStorage.removeItem(STORAGE_LAST_GAME_ID_KEY);
    localStorage.removeItem(STORAGE_LAST_SLOT_KEY);
    currentGameId = null;
    currentPlayerSlot = null;
    setStatus("Last saved game not found. Create or join a new one.");
    enableScorecard(false);
    setUnreadBadge(false);
    return;
  }

  const data = snap.data() || {};
  currentGameData = data;

  const players = Array.isArray(data.players) ? data.players : [];
  const myId = currentPlayerId;

  // 1) best case, find by player id
  let slot = players.findIndex(p => p && p.id === myId);

  // 2) fall back to stored slot if it exists and looks valid
  if (slot === -1 && savedSlotStr != null) {
    const storedSlot = parseInt(savedSlotStr, 10);
    if (!Number.isNaN(storedSlot) && players[storedSlot]) {
      slot = storedSlot;
    }
  }

  // 3) final fallback, default to slot 0 if someone is there
  if (slot === -1 && players[0]) {
    slot = 0;
  }

  if (slot !== -1) {
    currentPlayerSlot = slot;
    localStorage.setItem(STORAGE_LAST_SLOT_KEY, String(slot));
  } else {
    currentPlayerSlot = null;
  }

  // paint the UI with the game and enable your row
  applyGameToUI(currentGameData);
  enableScorecard(true);
  setStatus("Rejoined your last game. Enter scores as normal.");

  // live updates
  if (unsubscribeGame) unsubscribeGame();
  unsubscribeGame = docRef.onSnapshot(s => {
    if (!s.exists) {
      setStatus("Game was deleted or not found.", true);
      enableScorecard(false);
      return;
    }
    applyGameToUI(s.data());
    enableScorecard(true);
  });

  setUnreadBadge(false);
  messagesInitialized = false;
  attachMessageListener(currentGameId);
}

    // ==============================
    // Messaging and chat
    // ==============================
    function attachMessageListener(gameId) {
      if (!db || !gameId) return;

      if (unsubscribeMessages) {
        unsubscribeMessages();
        unsubscribeMessages = null;
      }

      messagesInitialized = false;

      unsubscribeMessages = db.collection("games")
        .doc(gameId)
        .collection("messages")
        .orderBy("createdAt", "desc")
        .limit(50)
        .onSnapshot(snapshot => {
          const all = [];
          snapshot.forEach(doc => {
            const msg = doc.data();
            if (!msg) return;

            const targets = Array.isArray(msg.toSlots) ? msg.toSlots : [];
            const isBroadcast = targets.length === 0;
            const isTargeted = currentPlayerSlot != null && targets.includes(currentPlayerSlot);
            const isMine = msg.fromId === currentPlayerId;

            if (isMine || isBroadcast || isTargeted) {
              all.push(
                Object.assign({}, msg, { isMine })
              );
            }
          });

          renderChatThreadMessages(all);

          if (!messagesInitialized) {
            messagesInitialized = true;
            return;
          }

          snapshot.docChanges().forEach(change => {
            if (change.type !== "added") return;

            const msg = change.doc.data();
            if (!msg || msg.fromId === currentPlayerId) return;

            const targets = Array.isArray(msg.toSlots) ? msg.toSlots : [];
            const isBroadcast = targets.length === 0;
            const isTargeted = currentPlayerSlot != null && targets.includes(currentPlayerSlot);

            if ((isBroadcast || isTargeted) && chatSheet && !chatSheet.classList.contains("visible")) {
              setUnreadBadge(true);
            }
          });
        });
    }

    function renderChatThreadMessages(messages) {
      if (!chatThread) return;
      chatThread.innerHTML = "";

      if (!messages || messages.length === 0) {
        const empty = document.createElement("div");
        empty.style.opacity = "0.7";
        empty.style.fontSize = "11px";
        empty.textContent = "No messages yet. Start the smack talk.";
        chatThread.appendChild(empty);
        return;
      }

      const sorted = messages.slice().sort((a, b) => {
        const ta = a.createdAt && a.createdAt.toMillis ? a.createdAt.toMillis() : 0;
        const tb = b.createdAt && b.createdAt.toMillis ? b.createdAt.toMillis() : 0;
        return ta - tb;
      });

      sorted.forEach(msg => {
        const wrap = document.createElement("div");
        wrap.className = "chat-message" + (msg.isMine ? " me" : "");

        const meta = document.createElement("span");
        meta.className = "meta";
        const name = msg.fromName || "Player";
        let scope = "all";
        if (Array.isArray(msg.toSlots) && msg.toSlots.length) {
          scope = "to " + msg.toSlots.map(s => "P" + (s + 1)).join(", ");
        }
        meta.textContent = msg.isMine ? (name + " (" + scope + ")") : name;

        const text = document.createElement("span");
        text.className = "text";
        text.textContent = msg.text || "";

        wrap.appendChild(meta);
        wrap.appendChild(text);
        chatThread.appendChild(wrap);
      });

      scrollChatToBottom();
    }

    function renderChatTargets() {
      if (!chatTargets) return;
      chatTargets.innerHTML = "";

      if (!currentGameData || !Array.isArray(currentGameData.players)) return;

      currentGameData.players.forEach((p, idx) => {
        if (!p || !p.id) return;

        const pill = document.createElement("button");
        pill.type = "button";
        pill.className = "chat-target-pill";
        pill.dataset.slot = String(idx);
        pill.textContent = p.name || ("Player " + (idx + 1));
        if (idx === currentPlayerSlot) {
          pill.textContent += " (you)";
        }
        pill.addEventListener("click", () => {
          pill.classList.toggle("selected");
        });
        chatTargets.appendChild(pill);
      });
    }

    function showChatSheet() {
      if (!chatSheet) return;
      renderChatTargets();
      setUnreadBadge(false);
      chatSheet.classList.add("visible");
      chatText.value = "";
      chatText.focus();
      setTimeout(scrollChatToBottom, 50);
    }

    function hideChatSheet() {
      if (!chatSheet) return;
      chatSheet.classList.remove("visible");
    }

    async function sendChatMessage() {
      if (!db) return;
      if (!currentGameId || currentPlayerSlot == null || !currentPlayerId) return;

      const text = chatText.value.trim();
      if (!text) return;

      const selectedSlots = Array.from(
        document.querySelectorAll(".chat-target-pill.selected")
      ).map(pill => parseInt(pill.dataset.slot, 10));

      const toSlots = selectedSlots.length ? selectedSlots : [];

      await db.collection("games")
        .doc(currentGameId)
        .collection("messages")
        .add({
          fromId: currentPlayerId,
          fromName: playerNameInput.value || "Player",
          fromSlot: currentPlayerSlot,
          toSlots,
          text,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

      chatText.value = "";
      hideChatSheet();
    }

    // ==============================
    // New game confirmation
    // ==============================
    function hasExistingGameData() {
      if (currentGameId) return true;

      let hasStuff = false;

      document.querySelectorAll(".player-name").forEach(inp => {
        if (inp.value && inp.value.trim() !== "") {
          hasStuff = true;
        }
      });

      document.querySelectorAll(".score-input").forEach(inp => {
        if (inp.value && inp.value.trim() !== "") {
          hasStuff = true;
        }
      });

      return hasStuff;
    }

    function showNewGameConfirm() {
      if (!newGameConfirm) return;
      newGameConfirm.classList.add("visible");
    }

    function hideNewGameConfirm() {
      if (!newGameConfirm) return;
      newGameConfirm.classList.remove("visible");
    }

    function handleCreateGameClick() {
      if (hasExistingGameData()) {
        showNewGameConfirm();
      } else {
        createGame().catch(err => {
          console.error(err);
          setStatus("Error creating game.", true);
        });
      }
    }

    // ==============================
    // Settings, theme
    // ==============================
    function openSettingsSheet() {
      if (!settingsSheet) return;
      if (themeSwitch) {
        themeSwitch.checked = body.dataset.mode === "dark";
      }
      if (accentSwitch) {
        accentSwitch.checked = body.dataset.accent === "invert";
      }
      settingsSheet.classList.add("visible");
    }

    function closeSettingsSheet() {
      if (!settingsSheet) return;
      settingsSheet.classList.remove("visible");
    }

    // ==============================
    // Analytics
    // ==============================
    function buildAnalyticsSummary() {
      if (!analyticsList) return;
      analyticsList.innerHTML = "";

      const rows = document.querySelectorAll(".player-row");
      let hasAny = false;

      rows.forEach(row => {
        const nameInput = row.querySelector(".player-name");
        const totalCell = row.querySelector(".total-col");
        if (!nameInput || !totalCell) return;

        const name = nameInput.value.trim();
        if (!name) return;

        const totalText = totalCell.textContent || "E";

        const rowDiv = document.createElement("div");
        rowDiv.className = "analytics-row";

        const nameSpan = document.createElement("span");
        nameSpan.className = "analytics-name";
        nameSpan.textContent = name;

        const scoreSpan = document.createElement("span");
        scoreSpan.className = "analytics-score";
        scoreSpan.textContent = totalText;

        rowDiv.appendChild(nameSpan);
        rowDiv.appendChild(scoreSpan);
        analyticsList.appendChild(rowDiv);
        hasAny = true;
      });

      if (!hasAny) {
        const empty = document.createElement("div");
        empty.style.fontSize = "13px";
        empty.style.opacity = "0.7";
        empty.textContent = "No scores yet. Fill in a few holes and your Pardle recap will appear here.";
        analyticsList.appendChild(empty);
      }
    }

    function openAnalyticsSheet() {
      if (!analyticsSheet) return;
      buildAnalyticsSummary();
      analyticsSheet.classList.add("visible");
    }

    function closeAnalyticsSheet() {
      if (!analyticsSheet) return;
      analyticsSheet.classList.remove("visible");
    }

    // ==============================
    // Start modal helpers
    // ==============================
    function hideStartModal() {
      if (!startModal) return;
      startModal.classList.add("hidden");
    }

    function handleStartPlayClick() {
      hideStartModal();
      setStatus("Not in a game. Create or join to start.");
      if (playerNameInput) {
        playerNameInput.focus();
      }
      attemptAutoRejoin().catch(err => {
        console.error(err);
        setStatus("Not in a game. Create or join to start.", true);
      });
    }

    function handleStartJoinClick() {
      hideStartModal();
      setStatus("Enter a game code or create a new one.");
      if (playerNameInput) {
        playerNameInput.focus();
      }
      setTimeout(() => {
        if (joinGameIdInput) {
          joinGameIdInput.focus();
        }
      }, 120);
    }

    function handleStartRulesClick() {
      hideStartModal();
      if (rulesCard) {
        rulesCard.classList.add("visible");
        rulesCard.scrollIntoView({ behavior: "smooth", block: "start" });
      }
    }

    // ==============================
    // Event wiring
    // ==============================
    if (gameIdPill) {
      gameIdPill.addEventListener("click", async () => {
        if (!currentGameId) return;
        try {
          await navigator.clipboard.writeText(currentGameId);
          const original = gameIdValue.textContent;
          gameIdValue.textContent = "Copied!";
          setTimeout(() => {
            gameIdValue.textContent = original;
          }, 1000);
        } catch (err) {
          console.error(err);
        }
      });
    }

    if (newGameCancelBtn) {
      newGameCancelBtn.addEventListener("click", hideNewGameConfirm);
    }

    if (newGameConfirmBtn) {
      newGameConfirmBtn.addEventListener("click", () => {
        hideNewGameConfirm();
        createGame().catch(err => {
          console.error(err);
          setStatus("Error creating game.", true);
        });
      });
    }

    if (settingsButton) {
      settingsButton.addEventListener("click", openSettingsSheet);
    }

    if (settingsCloseBtn) {
      settingsCloseBtn.addEventListener("click", closeSettingsSheet);
    }

    if (themeSwitch) {
      themeSwitch.addEventListener("change", () => {
        const mode = themeSwitch.checked ? "dark" : "light";
        body.dataset.mode = mode;
        localStorage.setItem(STORAGE_MODE_KEY, mode);
      });
    }

    if (accentSwitch) {
      accentSwitch.addEventListener("change", () => {
        const accent = accentSwitch.checked ? "invert" : "normal";
        body.dataset.accent = accent;
        localStorage.setItem(STORAGE_ACCENT_KEY, accent);
      });
    }

    if (analyticsButton) {
      analyticsButton.addEventListener("click", openAnalyticsSheet);
    }

    if (analyticsCloseBtn) {
      analyticsCloseBtn.addEventListener("click", closeAnalyticsSheet);
    }

    if (chatButton) {
      chatButton.addEventListener("click", () => {
        if (!currentGameId) {
          setStatus("Create or join a game before chatting.", true);
          return;
        }
        showChatSheet();
      });
    }

    if (chatCloseBtn) {
      chatCloseBtn.addEventListener("click", hideChatSheet);
    }

    if (chatCancelBtn) {
      chatCancelBtn.addEventListener("click", hideChatSheet);
    }

    if (chatSendBtn) {
      chatSendBtn.addEventListener("click", () => {
        sendChatMessage().catch(err => {
          console.error(err);
        });
      });
    }

    if (createGameBtn) {
      createGameBtn.addEventListener("click", handleCreateGameClick);
    }

    if (joinGameBtn) {
      joinGameBtn.addEventListener("click", () => {
        joinGame().catch(err => {
          console.error(err);
          setStatus("Error joining game.", true);
        });
      });
    }

    if (startPlayButton) {
      startPlayButton.addEventListener("click", handleStartPlayClick);
    }

    if (startJoinLink) {
      startJoinLink.addEventListener("click", handleStartJoinClick);
    }

    if (startRulesButton) {
      startRulesButton.addEventListener("click", handleStartRulesClick);
    }

    // ==============================
    // Init
    // ==============================
    bindScoreInputs();
    updateParRow();
    enableScorecard(false);
    setUnreadBadge(false);
  </script>
</body>
</html>
